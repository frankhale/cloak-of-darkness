/*! cloak-of-darkness 2015-11-07 */
"use strict";function _typeof(a){return a&&a.constructor===Symbol?"symbol":typeof a}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),CloakOfDarkness=function(){function a(){var a=[];for(var b in e)e.hasOwnProperty(b)&&(a=a.concat(e[b]));return a}function b(a){return"string"!=typeof a&&(a=JSON.stringify(a,void 0,2)),a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(a){var b="number";return/^"/.test(a)?b=/:$/.test(a)?"key":"string":/true|false/.test(a)?b="boolean":/null/.test(a)&&(b="null"),'<span class="'+b+'">'+a+"</span>"})}var c={title:"Cloak of Darkness",description:"Welcome, Cloak of Darkness is an implementation of the de facto 'Hello, World' of interactive  fiction by the same name. If you want to find out what a 'Cloak of Darkness' is you can find out more <a href='http://www.firthworks.com/roger/cloak' target='_blank'>here</a>.",author:"Frank Hale <frankhale@gmail.com>",releaseDate:"7 November 2015"},d={Enter:13,Up:38,Down:40},e={north:["north","n"],northEast:["northeast","ne"],northWest:["northwest","nw"],south:["south","s"],southEast:["southeast","se"],southWest:["southwest","sw"],east:["east","e"],west:["west","w"]},f=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"load",value:function(a,b,c){$.ajax({url:a,error:function(a){b(a)},success:function(a){c(a)}})}},{key:"read",value:function(a){var b=/^(\d+)\s+/,c=function(a){var c=[];return _.forEach(a,function(a){if(b.test(a)){var d=a.split(b).filter(function(a){return 0!=a.length});c.push({id:Number(d[0]),text:d[1]})}}),c},d=function(a){var b=[],c=_.uniq(_.pluck(a,"id"));return _.forEach(c,function(c){var d=_.where(a,{id:c}),e=_.pluck(d,"text").join(" ");b.push({id:c,text:e})}),b},e=function(a){var b=[],d=c(a),e=_.uniq(_.pluck(d,"id"));return _.forEach(e,function(a){var c=_.where(d,{id:a});b.push({id:a,group:_.pluck(c,"text")})}),b},f=function(a,b){var c=[],d=e(a);return _.forEach(d,function(a){var d={name:a.group.shift()};a.group.map(function(a){if(-1!=a.indexOf(":")){var c=a.split(":")[0],e=void 0;void 0!==b&&(e=b(c,a.replace(c+":","").trim())),void 0===e&&a.startsWith(c)?d[c]=a.replace(c+":","").trim().split(",").map(function(a){return a.trim()}):d[c]=e}}),c.push(d)}),c},g=function(a){return d(c(a))},h=function(a){var b=d(c(a)),e=[];return _.forEach(b,function(a){e.push({id:a.id,words:a.text.split(",").map(function(a){return a.trim()})})}),e},i=function(a){return f(a,function(a,b){return"synonyms"===a||"text"===a?b.split(",").map(function(a){return Number(a)}):void 0})},j=function(a){return f(a,function(a,b){return"synonyms"===a||"text"===a?b.split(",").map(function(a){return Number(a)}):void 0})},k=function(a){return f(a,function(a,b){return"rooms"===a?b.split(" ").map(function(a){return Number(a)}):void 0})},l=function(a){return f(a,function(a,b){if("synonyms"===a||"text"===a)return b.split(",").map(function(a){return Number(a)});if("wearable"===a){var c=!1;return b.toLowerCase().trim().substr("true")>-1?c=!0:b.toLowerCase().trim().substr("false")>-1&&(c=!1),c}})},m=function(a){return c(a).map(function(a){return{id:a.id,rooms:a.text.split(",").map(function(a){return Number(a)})}})},n=function(a){return f(a,function(a,b){return"items"===a?b.split(",").map(function(a){return Number(a)}):void 0})},o=a.split("\n").filter(function(a){return 0!=a.length}),p=o.shift().trim(),q={name:p};return"text"===p?q.data=g(o):"synonyms"===p?q.data=h(o):"rooms"===p?q.data=i(o):"actions"===p?q.data=j(o):"triggers"===p?q.data=k(o):"objects"===p?q.data=l(o):"exits"===p?q.data=m(o):"player"===p?q.data=n(o):q.data=[],q}}]),a}(),g=function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,Object.getPrototypeOf(b).apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"render",value:function(){var a={backgroundColor:"#000",position:"fixed",top:"0",width:"100%",paddingLeft:"10px"},b={backgroundColor:"#000",color:"#fff",marginBottom:"25px"},c={backgroundColor:"#000",color:"#fff"},d={backgroundColor:"#000",color:"#fff",right:"20px",position:"absolute"},e="";return void 0!==this.props.title&&this.props.title.length>0&&void 0!==this.props.room&&this.props.room.length>0&&(e=" | "),React.createElement("div",{id:"info",style:a},React.createElement("span",{id:"title",style:b},this.props.title," ",e),React.createElement("span",{id:"room",style:c},this.props.room),React.createElement("span",{id:"score",style:d},this.props.score))}}]),b}(React.Component),h=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(b).call(this));return a.onCommandInputKeyUp=a.onCommandInputKeyUp.bind(a),a.state={commandIndex:-1,commandsEntered:[]},a}return _inherits(b,a),_createClass(b,[{key:"componentDidMount",value:function(){function a(){b.width(window.innerWidth-50)}var b=$("#commandText");this.setState({commandText:b}),a(),$(window).resize(function(b){a()})}},{key:"onCommandInputKeyUp",value:function(a){var b=this;if(a.which===d.Up)!function(){var a=-1===b.state.commandIndex?b.state.commandsEntered.length-1:--b.state.commandIndex;0>a&&(a=0),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===d.Down)!function(){var a=-1===b.state.commandIndex?0:++b.state.commandIndex;a>b.state.commandsEntered.length&&(a=b.state.commandsEntered.length),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===d.Enter){var c=function(){var a=b.state.commandText.val();return a.length>0?(b.state.commandText.val(""),void b.setState({commandsEntered:_.uniq(b.state.commandsEntered.concat([a])),commandIndex:-1},function(){void 0!==this.props.onKeyEnter&&this.props.onKeyEnter(a)})):{v:void 0}}();if("object"===("undefined"==typeof c?"undefined":_typeof(c)))return c.v}}},{key:"render",value:function(){var a={paddingLeft:"10px"},b={border:"none",outline:"none",paddingLeft:"2px"};return React.createElement("div",{id:"commandContainer",style:a},">",React.createElement("input",{id:"commandText",style:b,type:"text",onKeyUp:this.onCommandInputKeyUp,autoFocus:!0}))}}]),b}(React.Component),i=function(d){function e(){_classCallCheck(this,e);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));c.onCommandEntered=c.onCommandEntered.bind(c);var d=[{synonyms:["exits","ex"],func:function(a,b,c,d){}.bind(c)},{synonyms:["inventory","i"],func:function(a,b,c,d){a.inventory.length>0?_.forEach(a.inventory,function(a){var b="";"garment"===a.type.name?(b=a.type.worn?"is":"is not",this.say(a.name+" (which "+b+" being worn)")):this.say(a.name)}.bind(this)):this.say("Your inventory contains no items.<br/>")}.bind(c)},{synonyms:["look","l"],func:function(a,b,c,d){}.bind(c)},{synonyms:["examine","x"],func:function(a,b,c,d){}.bind(c)},{synonyms:a(),func:function(a,b,c,d){}.bind(c)}],f=[{synonyms:["/debug"],func:function(a,c){var d=JSON.stringify(this.state.data,null,2);this.say("<h3>Game Data</h3><pre>"+b(d)+"</pre>")}.bind(c)},{synonyms:["/clear"],func:function(a,b){this.clear()}.bind(c)},{synonyms:["/restart"],func:function(a,b){this.clear(),this.startGame()}.bind(c)},{synonyms:["help","h"],func:function(a,b){var c=["<b>/clear</b> - clears the screen","<b>/restart</b> - restarts the game","<b>h, help</b> - prints this message","<b>i, inventory</b> - prints your inventory","<b>l, look</b> - prints the description of the current room","<b>x, examine</b> - prints a detailed description of an object","<b>ex, exits</b> - prints the list of exits for this room","<b>n, north, ne, northeast, nw, northwest, s, south, se, southeast, sw, southwest, e, east, w, west</b> - moves the player to a room relative to the direction specified"];this.say("<blockquote>"+c.join("<br/>")+"</blockquote>")}.bind(c)}];return c.state={playerCommands:d,systemCommands:f,roomName:"",score:0},c}return _inherits(e,d),_createClass(e,[{key:"initializePlayer",value:function(){return{score:0,room:{},inventory:[]}}},{key:"scrollContentArea",value:function(){$("html, body").animate({scrollTop:$(document).height()},1e3)}},{key:"clear",value:function(){this.state.content.html("")}},{key:"printCommand",value:function(a){this.state.content.append("<h3>&gt;"+a+"</h3>")}},{key:"say",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if(a.length>0){var c="";b&&(c="<p/>"),this.state.content.append(a+c),this.scrollContentArea()}}},{key:"startGame",value:function(){}},{key:"getCommand",value:function(a,b){var c={},d=function(b,d,e){c!=={}&&_.forEach(b,function(b){return _.indexOf(b.synonyms,a)>-1?(e({commandType:d,command:b}),!1):void 0})},b=function(a){c=a};return console.log("command = "+a),d(this.state.systemCommands,"system",b),c}},{key:"onCommandEntered",value:function(a){this.printCommand(a);var b=a.split(" "),c=b[0],d=b.slice(1),e=this.getCommand(c);void 0!==e.commandType&&"system"===e.commandType&&e.command.func(c,d),this.scrollContentArea()}},{key:"componentDidMount",value:function(){this.setState({content:$("#content"),data:this.props.data,player:this.initializePlayer()},function(){this.startGame()})}},{key:"render",value:function(){var a={marginTop:"50px",marginLeft:"10px"};return React.createElement("div",null,React.createElement(g,{title:c.title,room:this.state.roomName,score:this.state.score}),React.createElement("div",{id:"content",style:a}),React.createElement(h,{onKeyEnter:this.onCommandEntered}))}}]),e}(React.Component);return{init:function(){var a=new f;a.load("/assets/data/cloak-of-darkness-data.txt",function(a){console.log(a)},function(b){var c=b.split("\n\r"),d={};_.forEach(c,function(b){var c=a.read(b);d[c.name]=c.data}),ReactDOM.render(React.createElement(i,{data:d}),document.getElementById("ui"))})}}}();$(document).ready(function(){CloakOfDarkness.init()});