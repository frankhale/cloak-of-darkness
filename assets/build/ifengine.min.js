/*! cloak-of-darkness 2015-11-11 */
"use strict";function _typeof(a){return a&&a.constructor===Symbol?"symbol":typeof a}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),IFEngine=function(){function a(){var a=[];for(var b in d)d.hasOwnProperty(b)&&(a=a.concat(d[b]));return a}function b(a){return"string"!=typeof a&&(a=JSON.stringify(a,void 0,2)),a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(a){var b="number";return/^"/.test(a)?b=/:$/.test(a)?"key":"string":/true|false/.test(a)?b="boolean":/null/.test(a)&&(b="null"),'<span class="'+b+'">'+a+"</span>"})}var c={Enter:13,Up:38,Down:40},d={north:["north","n"],northEast:["northeast","ne"],northWest:["northwest","nw"],south:["south","s"],southEast:["southeast","se"],southWest:["southwest","sw"],east:["east","e"],west:["west","w"]},e=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"load",value:function(a,b,c){$.ajax({url:a,error:function(a){b(a)},success:function(a){c(a)}})}},{key:"read",value:function(a){var b=/^(\d+)\s+/,c=function(a){var c=[];return _.forEach(a,function(a){if(b.test(a)){var d=a.split(b).filter(function(a){return 0!=a.length});c.push({id:Number(d[0]),text:d[1]})}}),c},d=function(a){var b=[],c=_.uniq(_.pluck(a,"id"));return _.forEach(c,function(c){var d=_.where(a,{id:c}),e=_.pluck(d,"text").join(" ");b.push({id:c,text:e})}),b},e=function(a){var b=[],d=c(a),e=_.uniq(_.pluck(d,"id"));return _.forEach(e,function(a){var c=_.where(d,{id:a});b.push({id:a,group:_.pluck(c,"text")})}),b},f=function(a,b){var c=[],d=e(a);return _.forEach(d,function(a){var d={id:a.id,name:a.group.shift().trim()};a.group.map(function(a){if(-1!=a.indexOf(":")){var c=a.split(":")[0],e=void 0;void 0!==b&&(e=b(c,a.replace(c+":","").trim())),void 0===e&&a.startsWith(c)?d[c]=a.replace(c+":","").trim().split(",").map(function(a){return a.trim()}):d[c]=e}}),c.push(d)}),c},g=function(a){return d(c(a))},h=function(a){var b=d(c(a)),e=[];return _.forEach(b,function(a){e.push({id:a.id,words:a.text.split(",").map(function(a){return a.trim()})})}),e},i=function(a){return f(a,function(a,b){return"synonyms"===a||"text"===a?b.split(",").map(function(a){return Number(a)}):void 0})},j=function(a){return f(a,function(a,b){return"synonyms"===a||"text"===a?b.split(",").map(function(a){return Number(a)}):void 0})},k=function(a){return f(a,function(a,b){return"rooms"===a?b.split(" ").map(function(a){return Number(a)}):void 0})},l=function(a){return f(a,function(a,b){if("synonyms"===a||"text"===a)return b.split(",").map(function(a){return Number(a)});if("wearable"===a){var c=!1;return b.toLowerCase().trim().substr("true")>-1?c=!0:b.toLowerCase().trim().substr("false")>-1&&(c=!1),c}})},m=function(a){return f(a)},n=function(a){return c(a).map(function(a){return{id:a.id,rooms:a.text.split(",").map(function(a){return Number(a)})}})},o=function(a){return f(a,function(a,b){return"items"===a?b.split(",").map(function(a){return Number(a)}):"description"===a||"age"===a||"startRoom"===a?Number(b):void 0})},p=a.split("\n").filter(function(a){return 0!=a.length}),q=p.shift().trim(),r={name:q};return"text"===q?r.data=g(p):"synonyms"===q?r.data=h(p):"rooms"===q?r.data=i(p):"actions"===q?r.data=j(p):"triggers"===q?r.data=k(p):"objects"===q?r.data=l(p):"scenery"===q?r.data=m(p):"exits"===q?r.data=n(p):"player"===q?r.data=o(p):r.data=[],r}}]),a}(),f=function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,Object.getPrototypeOf(b).apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"render",value:function(){var a={backgroundColor:"#000",position:"fixed",top:"0",width:"100%",paddingLeft:"10px"},b={backgroundColor:"#000",color:"#fff",marginBottom:"25px"},c={backgroundColor:"#000",color:"#fff"},d={backgroundColor:"#000",color:"#fff",right:"20px",position:"absolute"},e="";return void 0!==this.props.title&&this.props.title.length>0&&void 0!==this.props.room&&this.props.room.length>0&&(e=" | "),React.createElement("div",{id:"info",style:a},React.createElement("span",{id:"title",style:b},this.props.title," ",e),React.createElement("span",{id:"room",style:c},this.props.room),React.createElement("span",{id:"score",style:d},this.props.score))}}]),b}(React.Component),g=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(b).call(this));return a.onCommandInputKeyUp=a.onCommandInputKeyUp.bind(a),a.state={commandIndex:-1,commandsEntered:[]},a}return _inherits(b,a),_createClass(b,[{key:"componentDidMount",value:function(){function a(){b.width(window.innerWidth-50)}var b=$("#commandText");this.setState({commandText:b}),a(),$(window).resize(function(b){a()})}},{key:"onCommandInputKeyUp",value:function(a){var b=this;if(a.which===c.Up)!function(){var a=-1===b.state.commandIndex?b.state.commandsEntered.length-1:--b.state.commandIndex;0>a&&(a=0),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===c.Down)!function(){var a=-1===b.state.commandIndex?0:++b.state.commandIndex;a>b.state.commandsEntered.length&&(a=b.state.commandsEntered.length),b.setState({commandIndex:a},function(){this.state.commandText.val(this.state.commandsEntered[a])})}();else if(a.which===c.Enter){var d=function(){var a=b.state.commandText.val();return a.length>0?(b.state.commandText.val(""),void b.setState({commandsEntered:_.uniq(b.state.commandsEntered.concat([a])),commandIndex:-1},function(){void 0!==this.props.onKeyEnter&&this.props.onKeyEnter(a)})):{v:void 0}}();if("object"===("undefined"==typeof d?"undefined":_typeof(d)))return d.v}}},{key:"render",value:function(){var a={paddingLeft:"10px"},b={border:"none",outline:"none",paddingLeft:"2px"};return React.createElement("div",{id:"commandContainer",style:a},">",React.createElement("input",{id:"commandText",style:b,type:"text",onKeyUp:this.onCommandInputKeyUp,autoFocus:!0}))}}]),b}(React.Component),h=function(c){function e(){_classCallCheck(this,e);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));c.onCommandEntered=c.onCommandEntered.bind(c);var f=[{synonyms:["exits","ex"],func:function(a,b,c,e){for(var f=[],g=[],h=0;h<a.room.exits.length;h++)0!==a.room.exits[h]&&g.push(h);g.map(function(a){var b=0;for(var c in d){if(b===a)return void f.push(c);b++}}),f.length>0&&this.say("the following exits are available: "+f.join(", "))}.bind(c)},{synonyms:["inventory","i"],func:function(a,b,c,d){this.say(c+" has not yet been implemented.")}.bind(c)},{synonyms:["look","l"],func:function(a,b,c,d){void 0!==a.room&&this.say(a.room.text[0].text)}.bind(c)},{synonyms:["examine","x"],func:function(a,b,c,d){if(d.length>0)if("self"===d[0].toLowerCase()||"me"===d[0].toLowerCase()){var e=_.find(this.state.data.player,{name:"self"});if(void 0!==e){var f=_.find(this.state.data.text,{id:e.description});this.say(f.text)}}else this.say("I don't know what that is.");else this.say("usage: x|examine [something]")}.bind(c)},{synonyms:a(),func:function(a,b,c,d){this.go(c)}.bind(c)}],g=[{synonyms:["/banner"],func:function(a,b){this.printBanner()}.bind(c)},{synonyms:["/save"],func:function(a,c){var d=JSON.stringify(this.state.player,null,2);this.say("<h3>Player Data</h3><pre>"+b(d)+"</pre>"),this.say("<h3>Encoded</h3>"+btoa(JSON.stringify(this.state.player,null,2)))}.bind(c)},{synonyms:["/restore"],func:function(a,c){var d=this;if(c.length>0)try{!function(){var a=JSON.parse(atob(c[0]));d.say("<h3>Restored Player Data</h3><pre>"+b(a)+"</pre>"),d.say("Restoring player save data.");var e=[],f=["score","rooms","inventory"];f.map(function(a){e.push(!0)}),e=_.find(e,!1),void 0===e&&(e=!0),e?d.setState({player:a},function(){this.say("Finished restoring player save data.")}.bind(d)):d.say("I cannot restore this save data.")}()}catch(e){this.say("Sorry I cannot restore your game.")}else this.say("usage: /restore [encoded string]")}.bind(c)},{synonyms:["/undo"],func:function(a,b){this.say("not yet implemented.")}.bind(c)},{synonyms:["/debug"],func:function(a,c){var d="";c.length>0&&this.state.data.hasOwnProperty(c[0])?(d=JSON.stringify(this.state.data[c[0]],null,2),this.say("<h3>Game Data - "+c[0]+"</h3>")):(d=JSON.stringify(this.state.data,null,2),this.say("<h3>Game Data - All</h3>")),this.say("<pre>"+b(d)+"</pre>")}.bind(c)},{synonyms:["/clear"],func:function(a,b){this.clear()}.bind(c)},{synonyms:["/restart"],func:function(a,b){this.clear(),this.startGame()}.bind(c)},{synonyms:["help","h"],func:function(a,b){var c=["<b>/banner</b> - prints the game title, description and author.","<b>/debug [key]</b> - prints the game data object for debugging purposes.","<b>/save</b> - prints an encoded string you can use to restore your game.","<b>/restore &lt;encoded string&gt;</b> - restores a previous game.","<b>/clear</b> - clears the screen","<b>/restart</b> - restarts the game","<b>h, help</b> - prints this message","<b>i, inventory</b> - prints your inventory","<b>l, look</b> - prints the description of the current room","<b>x, examine &lt;object&gt;</b> - prints a detailed description of an object","<b>ex, exits</b> - prints the list of exits for this room","<b>n, north, ne, northeast, nw, northwest, s, south, se, southeast, sw, southwest, e, east, w, west</b> - moves the player to a room relative to the direction specified"];this.say("<h3>Help:</h3><blockquote>"+c.join("<br/>")+"</blockquote>")}.bind(c)}];return c.state={playerCommands:f,systemCommands:g,roomName:"",score:0},c}return _inherits(e,c),_createClass(e,[{key:"initializePlayer",value:function(){return{score:0,room:{},inventory:[]}}},{key:"scrollContentArea",value:function(){$("html, body").animate({scrollTop:$(document).height()},1e3)}},{key:"clear",value:function(){this.state.content.html("")}},{key:"printCommand",value:function(a){this.state.content.append("<h3>&gt;"+a+"</h3>")}},{key:"printBanner",value:function(){this.say(this.state.gameInfo.title+"<br/>"),this.say(this.state.gameInfo.description),this.say("Author: "+this.state.gameInfo.author+"<br/>Release Date: "+this.state.gameInfo.releaseDate)}},{key:"say",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if(a.length>0){var c="";b&&(c="<p/>"),this.state.content.append(a+c),this.scrollContentArea()}}},{key:"getSynonyms",value:function(a){var b=_.find(this.state.data.synonyms,{id:a});return void 0!==b?b.words:[]}},{key:"getExits",value:function(a){var b=_.find(this.state.data.exits,{id:a});return void 0!==b?b.rooms:void 0}},{key:"getActions",value:function(a){}},{key:"getTriggers",value:function(a){}},{key:"getObjects",value:function(a){}},{key:"getText",value:function(a){var b=_.find(this.state.data.text,{id:a});return void 0!==b?b:[]}},{key:"getRoom",value:function(a){var b=this,c=_.find(this.state.data.rooms,{id:a});return void 0!==c?{id:a,name:c.name,synonyms:_.uniq(_.flatten(c.synonyms.map(function(a){return b.getSynonyms(a)}))),text:c.text.map(function(a){return b.getText(a)}),exits:this.getExits(a)}:void 0}},{key:"startGame",value:function(){var a=_.find(this.state.data.player,{name:"misc"}),b=this.getRoom(a.startRoom);if(void 0!==b){var c=this.initializePlayer();c.room=b,this.setState({player:c,roomName:c.room.name},function(){this.printBanner(),this.say("---"),this.say(b.text[0].text)}.bind(this))}}},{key:"getCommand",value:function(a){var b={},c=!1,d=function(a){b=a},e=function(d,e,f){b!=={}&&_.forEach(d,function(b){return _.indexOf(b.synonyms,a)>-1?(c=!0,f({commandType:e,command:b}),!1):void 0})};return e(this.state.systemCommands,"system",d),e(this.state.playerCommands,"player",d),c||this.say("I don't understand: "+a),b}},{key:"findAndExecuteTrigger",value:function(a){}},{key:"go",value:function(a){var b=this,c=_.findKey(d,function(b){return b.indexOf(a)>-1});void 0!==c&&!function(){var a=0;for(var e in d){if(e===c)break;a++}var f=b.getRoom(b.state.player.room.exits[a]);void 0!==f?(b.state.player.room=f,b.setState({roomName:b.state.player.room.name},function(){b.say("Entered: "+f.name),b.say(b.state.player.room.text[0].text)})):b.say("I cannot go in that direction.")}()}},{key:"onCommandEntered",value:function(a){this.printCommand(a);var b=a.split(" "),c=b[0],d=b.slice(1),e=this.getCommand(c);void 0!==e.commandType&&("player"===e.commandType?e.command.func(this.state.player,this.state.systemAPI,c,d):"system"===e.commandType&&e.command.func(c,d)),this.scrollContentArea()}},{key:"componentDidMount",value:function(){this.setState({content:$("#content"),gameInfo:this.props.gameInfo,data:this.props.data,player:this.initializePlayer(),systemAPI:{say:function(a,b){this.say(a,b)}.bind(this)}},function(){this.startGame()})}},{key:"render",value:function(){var a={marginTop:"50px",marginLeft:"10px"};return React.createElement("div",null,React.createElement(f,{title:this.props.gameInfo.title,room:this.state.roomName,score:this.state.score}),React.createElement("div",{id:"content",style:a}),React.createElement(g,{onKeyEnter:this.onCommandEntered}))}}]),e}(React.Component);return{init:function(a){var b=new e;b.load(a.dataFile,function(a){console.log(a)},function(c){var d=c.split("\n\r"),e={};_.forEach(d,function(a){var c=b.read(a);e[c.name]=c.data}),ReactDOM.render(React.createElement(h,{gameInfo:a,data:e}),document.getElementById("ui"))})}}}();